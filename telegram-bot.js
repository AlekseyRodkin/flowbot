// –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø - –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ getUpdates
require('dotenv').config();

console.log('üöÄ FlowList Bot - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...\n');

const TOKEN = process.env.TELEGRAM_BOT_TOKEN;
if (!TOKEN) {
  console.error('‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env!');
  process.exit(1);
}

// –ò—Å–ø–æ–ª—å–∑—É–µ–º node-telegram-bot-api –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
const TelegramBot = require('node-telegram-bot-api');

// –°–æ–∑–¥–∞–µ–º –±–æ—Ç–∞ —Å polling
const bot = new TelegramBot(TOKEN, { 
  polling: true,
  filepath: false // –û—Ç–∫–ª—é—á–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è
});

console.log('‚úÖ –ë–æ—Ç —Å–æ–∑–¥–∞–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º polling...\n');

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ /start
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const name = msg.from.first_name;
  
  console.log(`üì® /start –æ—Ç ${name} (@${msg.from.username})`);
  
  const welcome = `
üéØ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ FlowBot!</b>

–ü—Ä–∏–≤–µ—Ç, ${name}! 

–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –≤–æ–π—Ç–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –∑–∞ 15 –¥–Ω–µ–π —á–µ—Ä–µ–∑ —Ç–µ—Ö–Ω–∏–∫—É Flow List.

<b>–ß—Ç–æ —Ç—ã –ø–æ–ª—É—á–∏—à—å:</b>
‚úÖ –†–æ—Å—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ 3-5 —Ä–∞–∑
‚úÖ –ò–∑–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏–∏
‚úÖ –û—â—É—â–µ–Ω–∏–µ "–≤—Å—ë —É—Å–ø–µ–≤–∞—é"
‚úÖ –≠–Ω–µ—Ä–≥–∏—è –∏ –¥—Ä–∞–π–≤ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å

<b>–ö–æ–º–∞–Ω–¥—ã:</b>
/start - –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
/help - –ü–æ–º–æ—â—å
/tasks - –ü—Ä–∏–º–µ—Ä –∑–∞–¥–∞—á
`;
  
  bot.sendMessage(chatId, welcome, { parse_mode: 'HTML' });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ /help
bot.onText(/\/help/, (msg) => {
  const chatId = msg.chat.id;
  console.log(`üìã /help –æ—Ç @${msg.from.username}`);
  
  bot.sendMessage(chatId, `
üìñ –°–ø—Ä–∞–≤–∫–∞ FlowBot

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/start - –ù–∞—á–∞—Ç—å
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞  
/tasks - –ü—Ä–∏–º–µ—Ä –∑–∞–¥–∞—á –Ω–∞ –¥–µ–Ω—å

–ë–æ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.
–ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.
`);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ /tasks
bot.onText(/\/tasks/, (msg) => {
  const chatId = msg.chat.id;
  console.log(`üìù /tasks –æ—Ç @${msg.from.username}`);
  
  const tasks = `
<b>üìã –ü—Ä–∏–º–µ—Ä –∑–∞–¥–∞—á –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:</b>

<i>–ü—Ä–æ—Å—Ç—ã–µ (1-2 –º–∏–Ω—É—Ç—ã):</i>
‚Ä¢ –í—ã–ø–∏—Ç—å —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã
‚Ä¢ –°–¥–µ–ª–∞—Ç—å 5 –≥–ª—É–±–æ–∫–∏—Ö –≤–¥–æ—Ö–æ–≤
‚Ä¢ –£–ª—ã–±–Ω—É—Ç—å—Å—è —Å–µ–±–µ –≤ –∑–µ—Ä–∫–∞–ª–µ
‚Ä¢ –ù–∞–ø–∏—Å–∞—Ç—å –æ–¥–Ω–æ —Å–ª–æ–≤–æ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
‚Ä¢ –ü–æ—Ç—è–Ω—É—Ç—å—Å—è –Ω–∞ 30 —Å–µ–∫—É–Ω–¥

<i>–°—Ä–µ–¥–Ω–∏–µ (10-15 –º–∏–Ω—É—Ç):</i>
‚Ä¢ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ 3 —Å–æ–æ–±—â–µ–Ω–∏—è
‚Ä¢ –ü—Ä–æ—á–∏—Ç–∞—Ç—å 5 —Å—Ç—Ä–∞–Ω–∏—Ü –∫–Ω–∏–≥–∏
‚Ä¢ –°–¥–µ–ª–∞—Ç—å –º–∏–Ω–∏-–∑–∞—Ä—è–¥–∫—É
‚Ä¢ –ü–æ–∑–≤–æ–Ω–∏—Ç—å –¥—Ä—É–≥—É

<i>–°–ª–æ–∂–Ω—ã–µ (30+ –º–∏–Ω—É—Ç):</i>
‚Ä¢ –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤–∞–∂–Ω—É—é –∑–∞–¥–∞—á—É –ø–æ —Ä–∞–±–æ—Ç–µ
‚Ä¢ –ù–∞–ø–∏—Å–∞—Ç—å –ø–ª–∞–Ω –Ω–∞ –∑–∞–≤—Ç—Ä–∞

–í—ã–ø–æ–ª–Ω—è–π –ø–æ –ø–æ—Ä—è–¥–∫—É –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –ø–æ—Ç–æ–∫! üéØ
`;
  
  bot.sendMessage(chatId, tasks, { parse_mode: 'HTML' });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message', (msg) => {
  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—ã
  if (msg.text && msg.text.startsWith('/')) return;
  
  const chatId = msg.chat.id;
  console.log(`üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç @${msg.from.username}: "${msg.text}"`);
  
  bot.sendMessage(chatId, '–Ø –ø–æ–ª—É—á–∏–ª –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.');
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ polling
bot.on('polling_error', (error) => {
  console.error('‚ùå –û—à–∏–±–∫–∞ polling:', error.message);
  
  if (error.code === 'ETELEGRAM' && error.response.body.error_code === 409) {
    console.error('‚ö†Ô∏è  –ö–æ–Ω—Ñ–ª–∏–∫—Ç: –±–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ!');
    console.error('   –†–µ—à–µ–Ω–∏–µ: –ø–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞');
  }
});

// –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫
bot.on('polling', () => {
  console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  console.log('‚ïë   ‚úÖ FLOWBOT –£–°–ü–ï–®–ù–û –ó–ê–ü–£–©–ï–ù!         ‚ïë');
  console.log('‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£');
  console.log('‚ïë   ü§ñ –ë–æ—Ç: @FlowList_Bot               ‚ïë');
  console.log('‚ïë   üì± –°—Å—ã–ª–∫–∞: t.me/FlowList_Bot        ‚ïë');
  console.log('‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£');
  console.log('‚ïë   –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ       ‚ïë');
  console.log('‚ïë   –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É /start                 ‚ïë');
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
  console.log('\nüìä –õ–æ–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:\n');
});

// Graceful shutdown
process.on('SIGINT', () => {
  console.log('\n\nüëã –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...');
  bot.stopPolling();
  process.exit(0);
});

process.on('SIGTERM', () => {
  bot.stopPolling();
  process.exit(0);
});
