# Система паузы и контроля неактивности

## Описание

Реализована система автоматического контроля неактивности пользователей с возможностью постановки программы на паузу.

## Проблема

Бот каждое утро отправлял задачи даже неактивным пользователям, что приводило к:
- Накоплению невыполненных задач
- Потере мотивации пользователей
- Засорению чата

## Решение

### 1. Изменение порога увеличения уровня
- **Было:** Уровень увеличивается только при 100% выполнении задач
- **Стало:** Уровень увеличивается при выполнении ≥90% задач

### 2. Отслеживание неактивности
- Добавлено поле `last_interaction_date` - дата последнего взаимодействия
- Добавлено поле `inactive_days_count` - счётчик неактивных дней подряд
- При отметке задачи обновляется `last_interaction_date`

### 3. Предупреждение о неактивности
После 1 дня без выполнения задач (< 90%) пользователь получает сообщение с выбором:
- **Поставить на паузу** - утренние задачи не будут приходить
- **Закрыть все задачи** - отметить незавершённые как пропущенные
- **Продолжить** - получить задачи на сегодня

### 4. Режим паузы
- Добавлено поле `is_paused` в таблицу users
- При паузе утренние задачи не отправляются
- Текущий уровень и прогресс сохраняются
- Команда `/resume` снимает паузу

### 5. Статус задач
- Добавлено поле `status` в таблицу tasks (active/completed/skipped)
- Пропущенные задачи не учитываются в статистике
- Возможность массово отметить задачи как пропущенные

## Технические детали

### Миграция БД (012_add_pause_and_inactivity_fields.sql)

```sql
-- users таблица
ALTER TABLE users ADD COLUMN is_paused BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN inactive_days_count INTEGER DEFAULT 0;
ALTER TABLE users ADD COLUMN last_interaction_date DATE;

-- tasks таблица
ALTER TABLE tasks ADD COLUMN status VARCHAR(20) DEFAULT 'active';
```

### notificationService.js

**Изменения в sendTasksToUser():**
1. Проверка паузы - если `is_paused = true`, пропускаем отправку
2. Изменён порог: `completionRate >= 90` вместо `=== 100`
3. Подсчёт неактивных дней на основе `last_interaction_date`
4. Отправка предупреждения если `inactive_days_count >= 1`

**Логика подсчёта неактивности:**
```javascript
// Если выполнено ≥90% → сбрасываем счётчик
if (completionRate >= 90) {
  inactiveDaysCount = 0;
} else if (!wasActiveYesterday) {
  inactiveDaysCount++; // Увеличиваем только если не было взаимодействия
}
```

### pauseHandler.js (новый файл)

Обработчики для кнопок:
- `pauseProgram()` - устанавливает `is_paused = true`
- `skipAllTasks()` - отмечает все незавершённые задачи как `status = 'skipped'`
- `continueProgram()` - сбрасывает счётчик и отправляет задачи

### userService.js

Новые методы:
- `pauseUser(telegramId)` - поставить на паузу
- `resumeUser(telegramId)` - снять с паузы
- `resetInactiveDays(telegramId)` - сбросить счётчик
- `trackInteraction(telegramId)` - обновить `last_interaction_date`

### taskHandler.js

- В `completeTask()` и `toggleTask()` добавлен вызов `userService.trackInteraction()`
- Теперь методы принимают `userService` как параметр

### bot/index.js

**Добавлено:**
- Импорт pauseHandler
- Команда `/resume` - снять программу с паузы
- Callback handlers для `pause_program`, `skip_all_tasks`, `continue_program`
- Передача `userService` в `taskHandler.completeTask()`

## Пользовательский сценарий

### Сценарий 1: Неактивный пользователь

День 1:
- Пользователь получает 30 задач
- Выполняет 10 задач (33%)
- Не взаимодействует с ботом до конца дня

День 2 (утром):
- Бот проверяет вчерашние задачи: 33% < 90%
- `inactive_days_count = 1`
- **Отправляется предупреждение** с кнопками вместо задач

Пользователь нажимает "Поставить на паузу":
- `is_paused = true`
- Утренние задачи больше не приходят
- Прогресс сохранён

Позже пользователь готов продолжить:
- Команда `/resume`
- `is_paused = false`, `inactive_days_count = 0`
- Программа возобновлена

### Сценарий 2: Закрытие задач

Пользователь накопил задачи за несколько дней:
- Нажимает "Закрыть все задачи"
- Все незавершённые задачи → `status = 'skipped'`
- Счётчик неактивности сброшен
- Может продолжить с чистого листа

### Сценарий 3: Активный пользователь

День 1:
- Пользователь получает 30 задач
- Выполняет 28 задач (93%)

День 2:
- 93% ≥ 90% → уровень увеличивается
- `inactive_days_count = 0`
- Обычные задачи приходят без предупреждений

## Команды

### Для пользователей
- `/resume` - Снять программу с паузы

### Для разработчиков
```sql
-- Посмотреть паузы
SELECT telegram_id, is_paused, inactive_days_count, last_interaction_date
FROM users WHERE is_paused = true;

-- Посмотреть пропущенные задачи
SELECT * FROM tasks WHERE status = 'skipped';
```

## Файлы изменений

1. **database/migrations/012_add_pause_and_inactivity_fields.sql** - миграция БД
2. **src/services/notificationService.js** - логика проверки неактивности
3. **src/handlers/pauseHandler.js** - обработчики кнопок паузы
4. **src/services/userService.js** - методы для работы с паузой
5. **src/handlers/taskHandler.js** - tracking взаимодействий
6. **bot/index.js** - регистрация handlers и команд

## Тестирование

### Чеклист для тестирования:

- [ ] Применить миграцию БД
- [ ] Запустить бот
- [ ] Создать тестового пользователя
- [ ] Не выполнить задачи за день (<90%)
- [ ] На следующее утро получить предупреждение
- [ ] Протестировать кнопку "Поставить на паузу"
- [ ] Проверить что задачи не приходят
- [ ] Протестировать `/resume`
- [ ] Протестировать кнопку "Закрыть все задачи"
- [ ] Протестировать кнопку "Продолжить дальше"
- [ ] Проверить tracking взаимодействий при отметке задач

## Безопасность

- Все изменения обратно совместимы
- Старые пользователи автоматически получат новые поля при первом взаимодействии
- Пропущенные задачи сохраняются в БД для аналитики
- Pause не сбрасывает прогресс пользователя

## Производительность

- Добавлены индексы на `is_paused` и `status`
- Запросы оптимизированы для минимального количества обращений к БД
- Tracking взаимодействий выполняется асинхронно

---

**Дата:** 2025-11-22
**Версия:** 1.0
