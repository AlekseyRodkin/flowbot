// Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‰ÐµÐ³Ð¾ Ð±Ð¾Ñ‚Ð°
require('dotenv').config();
const { Telegraf } = require('telegraf');

console.log('ðŸš€ FlowList Bot - Ð—Ð°Ð¿ÑƒÑÐº...\n');

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚Ð¾ÐºÐµÐ½Ð°
const token = process.env.TELEGRAM_BOT_TOKEN;
if (!token) {
  console.error('âŒ TELEGRAM_BOT_TOKEN Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² .env Ñ„Ð°Ð¹Ð»Ðµ!');
  process.exit(1);
}

// Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð¾Ñ‚Ð°
const bot = new Telegraf(token);

// Ð¡Ñ‡ÐµÑ‚Ñ‡Ð¸Ðº ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸
let messageCount = 0;

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start
bot.start((ctx) => {
  messageCount++;
  const user = ctx.from;
  console.log(`âœ… [${messageCount}] /start Ð¾Ñ‚ @${user.username || user.first_name}`);
  
  const message = `
ðŸŽ¯ *Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² FlowBot!*

ÐŸÑ€Ð¸Ð²ÐµÑ‚, ${user.first_name}! 

Ð¯ Ð¿Ð¾Ð¼Ð¾Ð³Ñƒ Ñ‚ÐµÐ±Ðµ Ð²Ð¾Ð¹Ñ‚Ð¸ Ð² ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾Ñ‚Ð¾ÐºÐ° Ð·Ð° 15 Ð´Ð½ÐµÐ¹.

*Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:*
/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð·Ð°Ð½Ð¾Ð²Ð¾
/help - ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ
/tasks - ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð·Ð°Ð´Ð°Ñ‡ Ð½Ð° Ð´ÐµÐ½ÑŒ

_ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð» Ñ AI-Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÐµÐ¹ Ð·Ð°Ð´Ð°Ñ‡ Ð±ÑƒÐ´ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¿Ð¾ÑÐ»Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð²ÑÐµÑ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²._
`;
  
  ctx.replyWithMarkdown(message);
});

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /help
bot.help((ctx) => {
  messageCount++;
  console.log(`ðŸ“‹ [${messageCount}] /help Ð¾Ñ‚ @${ctx.from.username}`);
  
  ctx.reply(`
ðŸ“– ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ Ð¿Ð¾ FlowBot

ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹:
/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ
/help - Ð­Ñ‚Ð° ÑÐ¿Ñ€Ð°Ð²ÐºÐ°
/tasks - ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð·Ð°Ð´Ð°Ñ‡

Ð‘Ð¾Ñ‚ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ.
`);
});

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /tasks - Ð¿Ñ€Ð¸Ð¼ÐµÑ€
bot.command('tasks', (ctx) => {
  messageCount++;
  console.log(`ðŸ“ [${messageCount}] /tasks Ð¾Ñ‚ @${ctx.from.username}`);
  
  ctx.replyWithMarkdown(`
*ðŸ“‹ ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð·Ð°Ð´Ð°Ñ‡ Ð½Ð° ÑÐµÐ³Ð¾Ð´Ð½Ñ:*

_ÐŸÑ€Ð¾ÑÑ‚Ñ‹Ðµ (1-2 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹):_
â€¢ Ð’Ñ‹Ð¿Ð¸Ñ‚ÑŒ ÑÑ‚Ð°ÐºÐ°Ð½ Ð²Ð¾Ð´Ñ‹
â€¢ Ð¡Ð´ÐµÐ»Ð°Ñ‚ÑŒ 5 Ð³Ð»ÑƒÐ±Ð¾ÐºÐ¸Ñ… Ð²Ð´Ð¾Ñ…Ð¾Ð²
â€¢ Ð£Ð»Ñ‹Ð±Ð½ÑƒÑ‚ÑŒÑÑ

_Ð¡Ñ€ÐµÐ´Ð½Ð¸Ðµ (5-15 Ð¼Ð¸Ð½ÑƒÑ‚):_
â€¢ ÐžÑ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ð½Ð° 3 Ð¿Ð¸ÑÑŒÐ¼Ð°
â€¢ Ð¡Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð·Ð°Ñ€ÑÐ´ÐºÑƒ
â€¢ ÐŸÐ¾Ð·Ð²Ð¾Ð½Ð¸Ñ‚ÑŒ Ð´Ñ€ÑƒÐ³Ñƒ

_Ð¡Ð»Ð¾Ð¶Ð½Ñ‹Ðµ (30+ Ð¼Ð¸Ð½ÑƒÑ‚):_
â€¢ Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ð²Ð°Ð¶Ð½ÑƒÑŽ Ð·Ð°Ð´Ð°Ñ‡Ñƒ
â€¢ ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚

Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐ¹ Ð¿Ð¾ Ð¿Ð¾Ñ€ÑÐ´ÐºÑƒ Ð´Ð»Ñ Ð²Ñ…Ð¾Ð´Ð° Ð² Ð¿Ð¾Ñ‚Ð¾Ðº!
`);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð»ÑŽÐ±Ñ‹Ñ… Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', (ctx) => {
  messageCount++;
  const text = ctx.message.text;
  console.log(`ðŸ’¬ [${messageCount}] Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ @${ctx.from.username}: "${text}"`);
  
  if (!text.startsWith('/')) {
    ctx.reply('Ð¯ Ð¿Ð¾Ð½ÑÐ» Ð²Ð°ÑˆÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /help Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´.');
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
bot.catch((err, ctx) => {
  console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ°:', err);
  ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.');
});

// Ð—ÐÐŸÐ£Ð¡Ðš Ð‘ÐžÐ¢Ð
bot.launch()
  .then(() => {
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘   âœ… Ð‘ÐžÐ¢ Ð£Ð¡ÐŸÐ•Ð¨ÐÐž Ð—ÐÐŸÐ£Ð©Ð•Ð!             â•‘');
    console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
    console.log('â•‘   ðŸ¤– Ð‘Ð¾Ñ‚: @FlowList_Bot               â•‘');
    console.log('â•‘   ðŸ“± Ð¡ÑÑ‹Ð»ÐºÐ°: t.me/FlowList_Bot        â•‘');
    console.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
    console.log('â•‘   ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð±Ð¾Ñ‚Ñƒ /start Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸  â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('\nðŸ“Š Ð›Ð¾Ð³ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸:\n');
  })
  .catch(err => {
    console.error('\nâŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ:');
    
    if (err.response && err.response.error_code === 409) {
      console.error('Ð‘Ð¾Ñ‚ ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð² Ð´Ñ€ÑƒÐ³Ð¾Ð¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ!');
      console.error('Ð ÐµÑˆÐµÐ½Ð¸Ðµ: Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ 1 Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°');
    } else if (err.response && err.response.error_code === 401) {
      console.error('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð°!');
      console.error('ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ TELEGRAM_BOT_TOKEN Ð² .env Ñ„Ð°Ð¹Ð»Ðµ');
    } else {
      console.error(err.message);
    }
    
    process.exit(1);
  });

// Graceful shutdown
process.once('SIGINT', () => {
  console.log('\n\nðŸ‘‹ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ ÑÐ¸Ð³Ð½Ð°Ð» Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸...');
  bot.stop('SIGINT');
  console.log('âœ… Ð‘Ð¾Ñ‚ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½');
  process.exit(0);
});

process.once('SIGTERM', () => {
  bot.stop('SIGTERM');
  process.exit(0);
});
